<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>服务网格总结 | 北秋的秘密基地</title><meta name="author" content="北秋"><meta name="copyright" content="北秋"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="服务网格（Service Mesh）是一个专门处理服务通讯的基础设施层。它的职责是在由云原生应用组成服务的复杂拓扑结构下进行可靠的请求传送。在实践中，它是一组和应用服务部署在一起的轻量级的网络代理，并且对应用服务透明。">
<meta property="og:type" content="article">
<meta property="og:title" content="服务网格总结">
<meta property="og:url" content="https://beiqiu.top/article/1690b38e.html">
<meta property="og:site_name" content="北秋的秘密基地">
<meta property="og:description" content="服务网格（Service Mesh）是一个专门处理服务通讯的基础设施层。它的职责是在由云原生应用组成服务的复杂拓扑结构下进行可靠的请求传送。在实践中，它是一组和应用服务部署在一起的轻量级的网络代理，并且对应用服务透明。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s1.ax1x.com/2022/07/05/jYhAaD.jpg">
<meta property="article:published_time" content="2022-06-06T05:14:00.000Z">
<meta property="article:modified_time" content="2023-12-01T19:49:25.998Z">
<meta property="article:author" content="北秋">
<meta property="article:tag" content="服务网格">
<meta property="article:tag" content="未来趋势">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s1.ax1x.com/2022/07/05/jYhAaD.jpg"><link rel="shortcut icon" href="https://z1.ax1x.com/2023/11/16/pitl5tA.jpg"><link rel="canonical" href="https://beiqiu.top/article/1690b38e.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"G1RGPQQRS9","apiKey":"26a0a12c0576c8b9e40f4c6bb583907a","indexName":"BeiQiuIndexName","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 北秋","link":"链接: ","source":"来源: 北秋的秘密基地","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '服务网格总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-12-02 03:49:25'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.6/overall-situation/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/css/icon.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/css/universe.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/css/rightMenu.css"><link rel="apple-touch-icon" href="https://z1.ax1x.com/2023/11/16/pitl5tA.jpg"><meta name="apple-mobile-web-app-title" content="北秋的秘密基地"><link rel="bookmark" href="https://z1.ax1x.com/2023/11/16/pitl5tA.jpg"><link rel="apple-touch-icon-precomposed" sizes="180x180" href="https://z1.ax1x.com/2023/11/16/pitl5tA.jpg" ><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://npm.elemecdn.com/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><img class="load-image" src="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/404.gif" alt=""/></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://z1.ax1x.com/2023/11/16/pitl5tA.jpg" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/wallpaper/"><i class="fa-fw fas fa-images"></i><span> 壁纸</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-user-group"></i><span> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友人帐</span></a></li><li><a class="site-page child" href="/circle/"><i class="fa-fw fas fa-wifi"></i><span> 朋友圈</span></a></li><li><a class="site-page child" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-laptop-code"></i><span> 网站</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/sponsorWall/"><i class="fa-fw fas fa-money-check-alt"></i><span> 赞助墙</span></a></li><li><a class="site-page child" href="/tlink/"><i class="fa-fw fas fa-toolbox"></i><span> 工具墙</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-user-secret"></i><span> 个人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于北秋</span></a></li><li><a class="site-page child" href="/bookmarking/"><i class="fa-fw fas fa-infinity"></i><span> 网址收藏</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s1.ax1x.com/2022/06/23/jCECPP.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="北秋的秘密基地"><span class="site-name">北秋的秘密基地</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i><span> 相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/wallpaper/"><i class="fa-fw fas fa-images"></i><span> 壁纸</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-user-group"></i><span> 社交</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友人帐</span></a></li><li><a class="site-page child" href="/circle/"><i class="fa-fw fas fa-wifi"></i><span> 朋友圈</span></a></li><li><a class="site-page child" href="/comment/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page group hide" href="javascript:void(0);"><i class="fa-fw fas fa-laptop-code"></i><span> 网站</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/sponsorWall/"><i class="fa-fw fas fa-money-check-alt"></i><span> 赞助墙</span></a></li><li><a class="site-page child" href="/tlink/"><i class="fa-fw fas fa-toolbox"></i><span> 工具墙</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-user-secret"></i><span> 个人</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于北秋</span></a></li><li><a class="site-page child" href="/bookmarking/"><i class="fa-fw fas fa-infinity"></i><span> 网址收藏</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">服务网格总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-06-06T05:14:00.000Z" title="发表于 2022-06-06 13:14:00">2022-06-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-12-01T19:49:25.998Z" title="更新于 2023-12-02 03:49:25">2023-12-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/">服务网格</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>33分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="服务网格总结"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>前言：<br>服务网格（ServiceMesh）是一个专门处理服务通讯的基础设施层。它的职责是在由云原生应用组成服务的复杂拓扑结构下进行可靠的请求传送。在实践中，它是一组和应用服务部署在一起的轻量级的网络代理，并且对应用服务透明。</p>
<hr>
<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>服务网格（Service <a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Mesh&amp;spm=1001.2101.3001.7020">Mesh</a>）是一个专门处理服务通讯的基础设施层。它的职责是在由云原生应用组成服务的复杂拓扑结构下进行可靠的请求传送。<strong>在实践中，它是一组和应用服务部署在一起的轻量级的网络代理</strong>，并且对应用服务透明。</p>
<p>服务网格从总体<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E6%9E%B6%E6%9E%84&amp;spm=1001.2101.3001.7020">架构</a>上来讲比较简单，不过是一堆紧挨着各项服务的<strong>用户代理</strong>，外加一组<strong>任务管理组件</strong>组成。</p>
<p>管理组件被称为控制层或<strong>控制平面</strong>（control plane），负责与控制平面中的代理通信，下发策略和配置。</p>
<p>代理在服务网格中被称为数据层或数据平面（data plane），直接处理入站和出站数据包，转发、路由、健康检查、负载均衡、认证、鉴权、产生监控数据等。</p>
<p>一个典型的服务网格部署网络结构图如下：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/jYhAaD"><img src="https://s1.ax1x.com/2022/07/05/jYhAaD.jpg" alt="jYhAaD.jpg"></a></p>
<p>其中绿色方块为应用服务，蓝色方块为 Sidecar Proxy，应用服务之间通过 Sidecar Proxy 进行通信，整个服务通信形成图中的蓝色网络连线，图中所有蓝色部分就形成了 Service Mesh。</p>
<h1 id="服务网格带来了什么变化？"><a href="#服务网格带来了什么变化？" class="headerlink" title="服务网格带来了什么变化？"></a>服务网格带来了什么变化？</h1><ul>
<li><strong>第一，微服务治理与业务逻辑的解耦。</strong>服务网格把 SDK 中的大部分能力从应用中剥离出来，拆解为独立进程，以 sidecar 的模式进行部署。服务网格通过将服务通信及相关管控功能从业务程序中分离并下沉到基础设施层，使其和业务系统完全解耦，使开发人员更加专注于业务本身。</li>
<li><strong>第二，异构系统的统一治理。</strong>随着新技术的发展和人员更替，在同一家公司中往往会出现不同语言、不同框架的应用和服务，为了能够统一管控这些服务，以往的做法是为每种语言、每种框架都开发一套完整的 SDK，维护成本非常之高，而且给公司的中间件团队带来了很大的挑战。有了服务网格之后，通过将主体的服务治理能力下沉到基础设施，多语言的支持就轻松很多了。只需要提供一个非常轻量级的 SDK，甚至很多情况下都不需要一个单独的 SDK，就可以方便地实现多语言、多协议的统一流量管控、监控等需求。</li>
</ul>
<h1 id="Istio介绍"><a href="#Istio介绍" class="headerlink" title="Istio介绍"></a>Istio介绍</h1><p>Istio - 服务网格的典型实现。</p>
<p>Istio 是一个由Google和IBM等公司开源的，功能十分丰富的服务网格具体实现，也是目前业界最为流行的实现。它包括如下功能：</p>
<ul>
<li>流量管理：提供统一的流量治理功能，包括失败重试、超时、熔断/限流、路由管理、灰度发布、网关等功能。</li>
<li>可观测性：透明化地实现指标监控、日志、链路追踪等功能。</li>
<li>策略控制：实现访问控制系统、遥测捕获、配额管理和计费等。</li>
<li>安全认证：无侵入式地为服务增加认证、鉴权和加密通信的能力。</li>
<li>故障注入：支持随机向服务通信中注入故障（如模拟延时/网络中断），检测服务的可靠性</li>
</ul>
<h1 id="Istio架构"><a href="#Istio架构" class="headerlink" title="Istio架构"></a>Istio架构</h1><p>Istio 的架构从逻辑上分成数据平面（Data Plane）和控制平面（Control Plane）。</p>
<p>是否觉得似曾相识？没错，Kubernetes 的架构也具有相似的结构，分为控制节点和计算节点。毫无疑问，这样的设计可以很好地解耦各个功能组件。</p>
<ul>
<li>数据平面：由一组和业务服务成对出现的 Sidecar 代理（Envoy）构成，它的主要功能是接管服务的进出流量，传递并控制服务和 Mixer 组件的所有网络通信（Mixer 是一个策略和遥测数据的收集器，稍后会介绍）。</li>
<li>控制平面：主要包括了 Pilot、Mixer、Citadel 和 Galley 共 4 个组件，主要功能是通过配置和管理 Sidecar 代理来进行流量控制，并配置 Mixer 去执行策略和收集遥测数据（Telemetry）。</li>
</ul>
<p>Istio的架构图如下：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/jYhZPH"><img src="https://s1.ax1x.com/2022/07/05/jYhZPH.jpg" alt="jYhZPH.jpg"></a></p>
<p>架构补充：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/jYhEIe"><img src="https://s1.ax1x.com/2022/07/05/jYhEIe.jpg" alt="jYhEIe.jpg"></a></p>
<h1 id="Istio模块介绍"><a href="#Istio模块介绍" class="headerlink" title="Istio模块介绍"></a>Istio模块介绍</h1><h2 id="Istio-的核心控件Envoy"><a href="#Istio-的核心控件Envoy" class="headerlink" title="Istio 的核心控件Envoy"></a>Istio 的核心控件Envoy</h2><p>从上面的架构图可以看出，Istio 的数据平面就是指代理。Istio 选择 Envoy 作为 Sidecar 代理，Envoy 本质上是一个为面向服务的架构而设计的 7 层代理和通信总线。Envoy 基于 C++ 11 开发而成，性能出色。除了具有强大的网络控制能力外，Envoy 还可以将流量行为和数据提取出来发送给 Mixer 组件，用以进行监控。</p>
<p>Envoy 在网络控制方面的主要功能如下：</p>
<ul>
<li>HTTP 7 层路由</li>
<li>支持 gRPC、HTTP/2</li>
<li>服务发现和动态配置</li>
<li>健康检查</li>
<li>高级负载均衡</li>
</ul>
<p>我们知道，在Kubernetes环境中，同一个Pod内的不同容器间共享网络栈，这一特性使得Sidecar可以接管进出这些容器的网络流量，这就是Sidecar模式的实现基础。Envoy是目前Istio默认的数据平面，实际上因为Istio灵活的架构，完全可以选择其他兼容的产品作为Sidecar。目前很多服务网格产品都可以作为Istio的数据平面并提供集成。</p>
<h2 id="Pilot"><a href="#Pilot" class="headerlink" title="Pilot"></a>Pilot</h2><p>Pilot 是 Istio 实现流量管理的核心组件，它主要的作用是配置和管理 Envoy 代理。比如：可以为代理之间设置特定的流量规则，或者配置超时、重试、熔断这样的弹性能力。Pilot 会将控制流量行为的路由规则转换为 Envoy 的配置，并在运行时将它们广播到 Envoy。另外，Pilot 还能够把服务发现机制抽象出来并转换成 API 分发给 Envoy，使得后者具有服务发现的能力。</p>
<p>简单来说，Pilot 的主要任务有两个：</p>
<ul>
<li>从平台（如：Kubernetes）获取服务信息，完成服务发现</li>
<li><strong>获取 Istio 的各项配置，转换成 Envoy 代理可读的格式并分发</strong><ul>
<li><strong>注意：这块是经典的解耦设计，这样有个好处，即以后如果有其他类型的配置格式，也可以转换为Envoy可读的配置。试想下，如果由Envoy直接读取配置，后期接入其他格式的配置则需要修改Envoy代码，而Pilot的出现，则只要修改Pilot端代码就可以了。Pilot层不涉及到业务逻辑层，而是作为一个平台适配器，保障了其他核心组件配置规则的一致性，从而避免其它代码的反复修改。</strong></li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/jYhiqK"><img src="https://s1.ax1x.com/2022/07/05/jYhiqK.jpg" alt="jYhiqK.jpg"></a></p>
<h2 id="Mixer"><a href="#Mixer" class="headerlink" title="Mixer"></a>Mixer</h2><p>Mixer 的主要功能是提供策略控制，并从 Envoy 代理收集遥测数据。</p>
<p>每次网络通信时 Envoy 代理都会向 Mixer 发出预检要求，用来检测调用者的合法性。调用之后 Envoy 代理会发送遥测数据供 Mixer 收集。一般情况下 Sidecar 代理可以缓存这些数据，不需要频繁地调用 Mixer。</p>
<p>适配器是 Mixer 的重要组成部分，它本质上是一个插件模型，每个插件叫作适配器。这项特性使得 Mixer 可以接入几乎任意的（只要定义好接口）后端基础设施。比如可以选择接入不同的日志收集器、监控工具和授权工具等；可以在运行时切换不同的适配器或者是打开（关闭）它们；还可以自定义适配器以满足特定需求。适配器极大地提高了 Mixer 的扩展性，它让 Istio 的功能拥有了更多可能性。下图展示了 Mixer 的架构图并展示了它和 Envoy 的交互方式。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/jYhkVO"><img src="https://s1.ax1x.com/2022/07/05/jYhkVO.jpg" alt="jYhkVO.jpg"></a></p>
<h2 id="Citadel"><a href="#Citadel" class="headerlink" title="Citadel"></a>Citadel</h2><p>Citadel 是与安全相关的组件，主要负责密钥和证书的管理。它可以提供服务间和终端用户的身份认证，还可以加密服务网格中的流量。</p>
<h2 id="Galley"><a href="#Galley" class="headerlink" title="Galley"></a>Galley</h2><p>在 2019 年 3 月份发布的 1.1 版本中，Galley 作为一个独立的组件被添加到了架构当中（在此之前的版本中 Galley 并未独立出现），它现在是 Istio 主要的配置管理组件，负责配置的获取、处理和分发。Galley 使用了一种叫作 MCP（Mesh Configuration Protocol，网格配置协议）的协议与其他组件进行通信。</p>
<h1 id="Istio之流量管理"><a href="#Istio之流量管理" class="headerlink" title="Istio之流量管理"></a>Istio之流量管理</h1><p>微服务应用最大的痛点就是处理服务间的通信，而这一问题的核心其实就是流量管理。首先来看一看传统的微服务应用在没有服务网格介入的情况下，如何完成诸如金丝雀发布这样的动态路由。假设不借助任何现成的第三方框架，一个简单的实现方法是，在服务间添加一个负载均衡（如Nginx）做代理，通过修改配置的权重来分配流量。这种方式将对流量的管理和基础设施（云服务器、虚拟机、实体机等）绑定在了一起，难以维护。</p>
<p>而使用 Istio 就可以轻松地实现各种维度的流量控制。</p>
<p>下图展示了两种不同的金丝雀发布策略（新版本只对少数终端用户可用）。</p>
<p>第一种是根据权重把 5% 的流量路由给新版本；</p>
<p>第二种是根据请求的头信息 User-Agent 把使用 iPhone 的用户流量路由到新版本。</p>
<p>插曲：什么是金丝雀版本?金丝雀canary版本是一种软件技术版本，通过使新版本只对少数终端用户可用，这样可降低向每个人推出新代码和功能的风险。由于用户组的规模较小，新版本的影响相对较小。如果确定bug存在，或者新的功能或新的设计没有被很好地接受，那么很容易回滚。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/jYheGd"><img src="https://s1.ax1x.com/2022/07/05/jYheGd.jpg" alt="jYheGd.jpg"></a></p>
<p>Istio 的流量管理是通过 Pilot 和 Envoy 这两个组件实现的，将流量和基础设施进行了解耦。Pilot 负责配置规则，并把规则分发到 Envoy 代理去实施；而 Envoy 按照规则执行各种流量管理的功能，比如动态请求路由，超时、重试和熔断，还可以通过故障注入来测试服务之间的容错能力。下面对这些具体的功能进行逐一介绍。</p>
<h2 id="1、请求路由"><a href="#1、请求路由" class="headerlink" title="1、请求路由"></a>1、请求路由</h2><p>Istio 为了控制服务请求，引入了服务版本（Version）的概念，可以通过版本这一标签将服务进行区分。版本的设置是非常灵活的，可以根据服务的迭代编号进行定义（如 v1、v2 版本）；也可以根据部署环境进行定义（如 Dev、Staging 和 Production）；或者是自定义任何用于区分服务的标记。通过版本标签，Istio 就可以定义灵活的路由规则以控制流量，上面提到的金丝雀发布这类应用场景就很容易实现了。</p>
<p>下图展示了使用服务版本实现路由分配的例子。服务版本定义了版本号（v1.5、v2.0-alpha）和环境（us-prod、us-staging）两种信息。服务 B 包含了 4 个Pod，其中 3 个是部署在生产环境的 v1.5 版本，而 Pod4 是部署在预生产环境的 v2.0-alpha 版本。运维人员根据服务版本指定路由规则，通过 Pilot 同步给 Envoy 代理，使得 99% 的流量流向 v1.5 版本的生产环境，而 1% 的流量进入 v2.0-alpha 版本的预生产环境。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/jYhmRA"><img src="https://s1.ax1x.com/2022/07/05/jYhmRA.jpg" alt="jYhmRA.jpg"></a></p>
<h2 id="2、入口网关（Ingress）和出口网关（Egress）"><a href="#2、入口网关（Ingress）和出口网关（Egress）" class="headerlink" title="2、入口网关（Ingress）和出口网关（Egress）"></a>2、入口网关（Ingress）和出口网关（Egress）</h2><p>服务间通信是通过 Envoy 代理进行的。同样，我们也可以在整个系统的入口和出口处部署代理，使得所有流入和流出的流量都由代理进行转发，而这两个负责入口和出口的代理就叫作入口网关和出口网关。它们相当于整个微服务应用的边界代理，把守着进入和流出服务网格的流量。下图展示了 Ingress 和 Egress 在请求流中的位置，通过设置 Envoy 代理，出入服务网格的流量也得到了控制。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/jYhnxI"><img src="https://s1.ax1x.com/2022/07/05/jYhnxI.jpg" alt="jYhnxI.jpg"></a></p>
<h2 id="3、服务发现和负载均衡"><a href="#3、服务发现和负载均衡" class="headerlink" title="3、服务发现和负载均衡"></a>3、服务发现和负载均衡</h2><p>服务发现的前提条件是具有服务注册的能力。目前 Kubernetes 这类容器编排平台也提供了服务注册的能力。Istio 基于平台实现服务发现和负载均衡时，需要通过 Pilot 和 Envoy 协作完成，如下图所示。Pilot 组件会从平台获取服务的注册信息，并提供服务发现的接口，Envoy 获得这些信息并更新到自己的负载均衡池。Envoy 会定期地对池中的实例进行健康检查，剔除离线的实例，保证服务信息的实时性。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/jYhKMt"><img src="https://s1.ax1x.com/2022/07/05/jYhKMt.jpg" alt="jYhKMt.jpg"></a></p>
<h1 id="Istio之故障处理"><a href="#Istio之故障处理" class="headerlink" title="Istio之故障处理"></a>Istio之故障处理</h1><p>Istio 的故障处理都由 Envoy 代理完成。Envoy 提供了一整套现成的故障处理机制，比如超时、重试、限流和熔断等。这些功能都能够以规则的形式进行动态配置，并且执行运行时修改。这使得服务具有更好的容错能力和弹性，并保证服务的稳定性。</p>
<h1 id="Istio之故障注入"><a href="#Istio之故障注入" class="headerlink" title="Istio之故障注入"></a>Istio之故障注入</h1><p>简单来说，故障注入就是在系统中人为地设置一些故障，来测试系统的稳定性和系统恢复的能力。</p>
<p>比如为某服务设置一个延迟，使其长时间无响应，然后检测调用方是否能处理这种超时问题而自身不受影响（如及时终止对故障发生方的调用，避免自己受到影响且使故障扩展）。</p>
<p>故障注入怎么实现的？也很简单，比如延迟，不是真的去让服务组件故障延迟，而是在获取到服务组件的数据之后，在Envoy端进行延迟。</p>
<p>Isito 支持注入两种类型的故障：<strong>延迟和中断。</strong></p>
<p>延迟是模拟网络延迟或服务过载的情况；</p>
<p>中断是模拟上游服务崩溃的情况，表现为 HTTP 的错误码和 TCP 连接失败。</p>
<h1 id="策略和遥测"><a href="#策略和遥测" class="headerlink" title="策略和遥测"></a>策略和遥测</h1><h2 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h2><p>在微服务应用中，除了流量管理以外，常常还需要进行一些额外的控制，比如限流（对调用频率、速率进行限制）、设置白名单和黑名单等。</p>
<p>Istio 中的策略控制是依靠 Mixer 完成的。Envoy 代理在每次网络请求时，都会调用 Mixer 进行预先检查，确定是否满足对应的策略。同时，Mixer 又可以根据这些来自流量的数据，进行指标数据的采集和汇总，这就是遥测功能。</p>
<h2 id="遥测（Telemetry）"><a href="#遥测（Telemetry）" class="headerlink" title="遥测（Telemetry）"></a>遥测（Telemetry）</h2><p>遥测是工业上常用的一种技术，它是指从远程设备中收集数据，并传输到接收设备进行监测。在软件开发中，遥测的含义引申为对各种指标（metric）数据进行收集，并监控、分析这些指标，比如我们经常听到的 BI 数据分析。</p>
<p>Mixer 的一大主要功能就是遥测。前面已经说过，Envoy 代理会发送数据给 Mixer，这就使得 Mixer 具有了数据收集的能力。在对 Mixer 的介绍中读者已经了解到 Mixer 的插件模型，也就是适配器。Mixer 可以接入不同的后端设施作为适配器，来处理收集到的指标数据，比如：日志分析系统、监控系统等。</p>
<h1 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h1><p>在微服务应用越来越复杂的情况下，对整个系统的状态进行监控和追踪变得尤为重要。试想如果一个包含上百个服务的系统发生了故障却无法准确定位问题的根源，或者系统压力已经到了承受的临界值而运维人员却浑然不知，这是多么可怕的事情。没有完备的、可观察的监控系统就无法保障系统的稳定性。</p>
<p>Istio 可以很方便地和各种监控、追踪工具集成，以便我们以可视化的方式（网页）直观地查看整个系统的运行状态。比如：可以集成 Prometheus 来进行指标数据的收集，然后将收集的数据放在 Grafana 监控工具中展示；还可以集成 Jaeger 作为追踪系统，帮助我们对请求的调用链进行跟踪，在故障发生时分析出现问题的根源；或者将请求日志记录到 Kibana 系统，以图表的方式进行数据分析。</p>
<p>以上提到的这些可视化工具都会在集成到 Istio 中得到详细的介绍。</p>
<h1 id="VirtualService路由规则配置"><a href="#VirtualService路由规则配置" class="headerlink" title="VirtualService路由规则配置"></a>VirtualService路由规则配置</h1><p>virtualService是istio最主要最复杂的核心配置，主要负责配置服务的调用规则，分发规则等等，在详细介绍vs功能之前，可以先查看以下的简化配置内容</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">reviews</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">reviews</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">      <span class="attr">end-user:</span></span><br><span class="line">        <span class="attr">exact:</span> <span class="string">jason</span></span><br><span class="line">      <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">      <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">      <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure>
<p>metadata_name： vs的名称</p>
<p>spec_hosts：对应服务的service名称</p>
<p>spec_http_match：路由规则<br>上面表达式的内容解说过来为：对reviews服务的访问请求中，如果请求头的end-user的值为jason，则将流量路由到reviews服务的v2版本上，其他流量路由在v1版</p>
<h2 id="vs配置中的关键配置项"><a href="#vs配置中的关键配置项" class="headerlink" title="vs配置中的关键配置项:"></a>vs配置中的关键配置项:</h2><ol>
<li><p>hosts：表示流量发送的目标（可以理解为拦截目标，也可以理解为配置的路由规则归属哪一个Sidecar），在k8s中hosts需要配置为服务的service域名，同namesapce下可以配置 <strong>短域名</strong>（因为可以跨namespace配置路由规则，所以这里是不便于管理的，如果重新开发istio配置管理dashboard可以考虑为域名分配增加权限）</p>
</li>
<li><p>http: 是一个类似httpRoute的路由集合，用于处理http的流量，是istio最丰富的的流量规则</p>
</li>
<li><p>tls：是一个tlsRoute类型的路由集合，用于处理非终结的tls和https流量</p>
</li>
<li><p>tcp：是一个tcpRoute类型的路由集合，用于处理tcp流量，应用于所有非http和tls端口的流量</p>
</li>
<li><p>exportTo：是istio在1.1版本后的新增特性，用于控制VS跨namespace的可见性。可以控制在一个命名空间下定义的vs是否可以被其他命名空间的Sidecar和Gateway使用。不填写代表全局可见，”.“代表仅当前namespace可见，”* “代表所有namespace可见。</p>
</li>
</ol>
<h2 id="HttpRoute"><a href="#HttpRoute" class="headerlink" title="HttpRoute"></a>HttpRoute</h2><p>在正常使用时，http协议的路由应用场景最多，主要介绍一下http路由的使用场景和使用方法</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/jUMKPA"><img src="https://s1.ax1x.com/2022/07/06/jUMKPA.jpg" alt="jUMKPA.jpg"></a></p>
<p>如上图，httproute可以通过请求中的内容为条件，对请求进行重定向、重写、重试、故障注入、流量复制等操作<br>我们把这些步骤拆分一下，主要分为匹配规则，重定向，重写，重试，故障注入，流量复制这几个方面来详述。</p>
<h2 id="HTTPRoute的匹配规则"><a href="#HTTPRoute的匹配规则" class="headerlink" title="HTTPRoute的匹配规则"></a>HTTPRoute的匹配规则</h2><p>简述：匹配规则是分发流量的重要条件，关键字段是match字段，在match字段下就是对请求路由的匹配方式。</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/jUMn5d"><img src="https://s1.ax1x.com/2022/07/06/jUMn5d.jpg" alt="jUMn5d.jpg"></a></p>
<p>uri、scheme、method、authority：这4个字段都是StringMatch类型，请求规则中都支持exact（完全匹配），prefix（前缀匹配）、regex（正则匹配）三种匹配方式<br>headers：匹配请求中的header，是一个map类型，所以匹配时以k-v的形式比对，对每一个header的值都可以使用exact，prefix、regex三种匹配方式。<br>例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">match:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span> </span><br><span class="line">        <span class="attr">end-user:</span> </span><br><span class="line">            <span class="attr">exact:</span> <span class="string">jason</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/testPipeline&quot;</span></span><br></pre></td></tr></table></figure>
<p>以上规则中包含了1和2的使用方式，代表匹配请求头中的end-user的值为jason且uri以/testPipeline开头的请求。</p>
<p>注意，条件或怎么写？如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">match:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span> </span><br><span class="line">        <span class="attr">end-user:</span> </span><br><span class="line">            <span class="attr">exact:</span> <span class="string">jason</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">&quot;/testPipeline&quot;</span></span><br></pre></td></tr></table></figure>
<p>port：表示请求的端口，在使用时大部分的服务都只开放了一个端口，在这种场景下可以不用指定端口（port在实际使用中使用率会小些）<br><strong>sourceLabels：表示请求来源服务的标签，在k8s中这个标签就是指pod的标签。</strong><br>例：<br>http:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">sourceLabels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">cicdfront</span></span><br><span class="line">        <span class="attr">version:</span> <span class="string">v1.0.10</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">cicdapi</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1.0.10</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">cicdapi</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1.0.9</span></span><br></pre></td></tr></table></figure>
<p><strong>当请求服务来源为cicdfront且其pod版本为v1.0.10时会将流量转发到cicdapi的v1.0.10上，其他的请求会发送到cicdapi的v1.0.9版本上</strong></p>
<h2 id="HttpRoute的路由目标"><a href="#HttpRoute的路由目标" class="headerlink" title="HttpRoute的路由目标"></a>HttpRoute的路由目标</h2><p>简述：路由目标代表请求流量发送到的目标服务，<strong>关键字段是route</strong>，在match（匹配规则）下时常代表匹配规则后的发送请求的目标服务。<br>当请求完成匹配规则后，我们需要对匹配到的请求进行转发，我们还是以开始的配置举例(稍微改动一下)。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">headers:</span></span><br><span class="line">        <span class="attr">end-user:</span></span><br><span class="line">          <span class="attr">exact:</span> <span class="string">jason</span></span><br><span class="line">    <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v2</span></span><br><span class="line">     <span class="attr">weight:</span> <span class="number">30</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v3</span></span><br><span class="line">     <span class="attr">weight:</span> <span class="number">70</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">reviews</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1</span></span><br></pre></td></tr></table></figure>
<p><strong>通过上节的匹配规则我们可以理解match中的匹配规则为请求头中的end-user的值为jason。当匹配这一条件时route路由生效，将请求的30%发送到reviews服务的v2版本上，另外70%发送到reviews服务的v3版本上。对未能匹配的请求路由到v1版本上。</strong></p>
<p>这一转发需要搭配istio的另一个重要配置DR（DestinationRule）使用，DR中通过标签定义不同的pod服务。通过subset子集来完成请求的调用，这里按reviews服务的v1 v2两个pod理解就好:</p>
<ul>
<li><strong>destination中的host与http中的host一致，在k8s中也是指向的service的域名</strong>，可以省略部分内容做短域名（在同namespace下的时候）。subset代表对应的dr子集。</li>
<li><strong>weight：除了destination之外的另一个重要属性主要用于流量分配的比例，在一个route下多个dr下流量权重之和必须为100</strong></li>
</ul>
<h2 id="HTTPRedirect重定向"><a href="#HTTPRedirect重定向" class="headerlink" title="HTTPRedirect重定向"></a>HTTPRedirect重定向</h2><p>简述：istio可以人工注入一些不可见的重定向规则，<strong>自定义的重定向规则在redirect关键字下。</strong><br>理解了istio的vs工作模式那么我们接下来继续看istio的重定向功能。</p>
<p>比较常见的使用场景：网站系统的网站地址发生了变化（并非服务器变化，只是访问地址的请求后缀变化），<strong>要求使用之前的访问地址也能够进入网站，不影响旧用户的操作</strong>。这种情况下就很适合使用istio的重定向功能</p>
<ul>
<li>uri：替换url中的path部分</li>
<li>authority：替换url中的authority部分</li>
</ul>
<p>例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cicdapi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cicdapi</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/pipeline</span></span><br><span class="line">      <span class="attr">redirect:</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">/cicd/pipeline</span></span><br><span class="line">        <span class="attr">authority:</span> <span class="string">newcicd</span></span><br></pre></td></tr></table></figure>
<p>以上的请求对cicdapi服务的/pipeline请求都会被重定向到newcicd服务的/cicd/pipeline上</p>
<h2 id="HTTPRewrite重写"><a href="#HTTPRewrite重写" class="headerlink" title="HTTPRewrite重写"></a>HTTPRewrite重写</h2><p>简述：istio可以在请求发送给目标服务之前对请求信息进行改写，这个改写过程是对客户端及服务端都不可见的。重写与重定向很像。<br>关键字：rewrite</p>
<ol>
<li>uri: 重写url中的path部分</li>
<li>authority: 重写url中的authority部分</li>
</ol>
<p>例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cicdapi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cicdapi</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">match:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">/pipeline</span></span><br><span class="line">      <span class="attr">rewrite:</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">/cicd/pipeline</span></span><br></pre></td></tr></table></figure>
<h2 id="HTTPRerty重试"><a href="#HTTPRerty重试" class="headerlink" title="HTTPRerty重试"></a>HTTPRerty重试</h2><p>简述：很多时候http请求发生异常，重试都是解决异常的最直接，最简单的办法，尤其是环境比较复杂的情况下，可以提高总体的服务质量，<strong>但是这个重试逻辑如果放在客户端进行调度就过于不规范，不便于管理</strong>。istio可以支持这种重试的自动调度。<br>关键字：retry</p>
<ol>
<li>attempts：必填字段，定义重试的次数</li>
<li>perTryTimeout：每次重试的超时时间，单位可以是毫秒(ms)，秒(s)，分钟(m)和小时(h)</li>
<li>retryOn: 重试的条件，可以是多个条件以逗号分隔。可用条件有以下内容</li>
</ol>
<ul>
<li>（1）5xx：在上游服务返回5xx的返回码，或在没有响应的时候进行重试</li>
<li>（2）gateway-error：类似5xx异常，只对502,503,504的路由异常进行重试</li>
<li>（3）connect-failure：在连接上游服务失败时重试</li>
<li>（4）retriable-4xx：在上游服务返回4xx返回码时进行重试（这里可能不包括部分返回码，如404,405）</li>
<li>（5）refused-stream：在上游服务使用REFUSED_STREAM错误码重置时重试</li>
<li>（6）cancelled：在gRPC应答的Header中状态码是cancelled时重试</li>
<li>（7）deadline-exceeded：在gRPC应答的Header中的状态码是deadline-exceeded时重试</li>
<li>（8）internal：在gRPC应答的Header中的状态码是internal时重试</li>
<li>（9）resource-exhausted：在gRPC应答的Header中的状态码是resource-exhausted时重试</li>
<li>（10）unavailable：在gRPC应答的Header中的状态码是unavailable时重试</li>
</ul>
<p>例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cicdapi</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cicdapi</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">cicdapi</span></span><br><span class="line">     <span class="attr">retries:</span></span><br><span class="line">       <span class="attr">attempts:</span> <span class="number">5</span></span><br><span class="line">       <span class="attr">perTryTimeout:</span> <span class="string">3s</span></span><br><span class="line">       <span class="attr">retryOn:</span> <span class="string">5xx,connect-failure</span></span><br></pre></td></tr></table></figure>
<h2 id="Mirror流量复制"><a href="#Mirror流量复制" class="headerlink" title="Mirror流量复制"></a>Mirror流量复制</h2><p>简述：<strong>流量复制是指在流量需要发送到某个服务时，将这个请求流量复制一份到一个指定的服务上</strong>，如下图。可以将生产系统的流量复制到一个需要更新的新版本服务上，这样完全不会对生产系统产生影响，这里只复制了一份流量，数据面代理只需要住原来的流量就可以了。<br>关键字：mirror</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/jUMM8I"><img src="https://s1.ax1x.com/2022/07/06/jUMM8I.jpg" alt="jUMM8I.jpg"></a></p>
<p>例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">portal-web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">portal-web</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">portal-web</span></span><br><span class="line">          <span class="attr">subset:</span> <span class="string">v1.0.15</span></span><br><span class="line">      <span class="attr">mirror:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">portal-web</span></span><br><span class="line">        <span class="attr">subset:</span> <span class="string">v1.0.16</span></span><br></pre></td></tr></table></figure>
<h2 id="HttpFaultInjection故障注入"><a href="#HttpFaultInjection故障注入" class="headerlink" title="HttpFaultInjection故障注入"></a>HttpFaultInjection故障注入</h2><p>简述：除了转发重试这些常用的http请求操作，istio还支持故障注入。主要用于测试时<strong>主动模拟一些异常场景</strong>，比如跨服务请求超时，访问中发生错误等情况。</p>
<p><strong>这个作用主要是观察微服务中，某个服务处故障时，整体服务的健康状况，观察是否会出现级联影响的情况。</strong></p>
<p>在istio中故障注入主要分为两种</p>
<p>延迟故障注入</p>
<p>延迟故障注入用来模拟超时的场景，模拟网络负载等原因导致的请求失败</p>
<p>配置参数如下：<br>（1）fixedDelay：必选字段，表示延迟的时间，单位可以是毫秒，秒，分钟，小时。要求时间必须大于1毫秒</p>
<p>（2）percentage：选填字段，配置故障发生的比例，通过这个配置可以配置故障发生的比例（无单位，支持小数，表示百分比。如果不填默认为100，注入所有请求）。</p>
<p>例：<br>……<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">……</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">portal-web</span></span><br><span class="line">          <span class="attr">subset:</span> <span class="string">v1.0.15</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">fault：</span></span><br><span class="line">    <span class="string">delay：</span></span><br><span class="line">       <span class="string">percentage：</span></span><br><span class="line">         <span class="attr">value:</span> <span class="number">1.5</span></span><br><span class="line">       <span class="attr">fixedDelay:</span> <span class="string">10s</span></span><br></pre></td></tr></table></figure></p>
<p>表示对portal-web服务的请求的百分之1.5会被注入10s的延迟</p>
<p>请求中止故障注入</p>
<p>请求中止故障注入，主要是为了模拟服务端故障的情况，可以注入指定的返回码和返回信息</p>
<p>配置参数如下：<br>（1）httpStatus：是一个必选字段，表示中止的HTTP状态码</p>
<p>（2）percentage：配置的中止故障作用在多少比例的请求上，配置方式与延迟故障的一致。<br>例：<br>……</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">……</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">portal-web</span></span><br><span class="line">          <span class="attr">subset:</span> <span class="string">v1.0.15</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">fault：</span></span><br><span class="line">    <span class="string">delay：</span></span><br><span class="line">       <span class="string">percentage：</span></span><br><span class="line">         <span class="attr">value:</span> <span class="number">1.5</span></span><br><span class="line">       <span class="attr">httpStatus:</span> <span class="number">500</span></span><br></pre></td></tr></table></figure>
<p>对portal-web服务的请求的百分之1.5会被模拟返回500的异常。</p>
<p>其实当了解了vs的大部分功能之后，我们可以看到vs的作用其实与k8s的service的作用基本是一致的，只是vs是用来修饰service的服务，可以调整、组合、拼接service，将多个service拼装成一个大的，富有规则的service。</p>
<h1 id="DestinationRule目标规则"><a href="#DestinationRule目标规则" class="headerlink" title="DestinationRule目标规则"></a>DestinationRule目标规则</h1><p>在我们刚刚查看VirtualService时候经常能看到这样一段配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">          <span class="attr">host:</span> <span class="string">portal-web</span></span><br><span class="line">          <span class="attr">subset:</span> <span class="string">v1.0.15</span></span><br></pre></td></tr></table></figure>
<p>之前说这段配置指的是将流量发送给portal-web的v1.0.15的版本，这样说是为了方便理解。实际上这种说法是不严谨的，<strong>这段配置真实代表的含义是将请求转发给portal-web服务的destinationRule的v1.0.15的子集。</strong></p>
<p>DestinationRule配置样例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cicdpai</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">cicdapi</span></span><br><span class="line">  <span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v3</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v3</span></span><br></pre></td></tr></table></figure>
<h2 id="DestinationRule规则定义"><a href="#DestinationRule规则定义" class="headerlink" title="DestinationRule规则定义"></a>DestinationRule规则定义</h2><p><strong>destinationRule经常与virtualService一起使用</strong>（dr是配合vs一起使用的，但是vs并不要求一定需要使用dr，如果不使用dr，vs会直接使用service来负载调用对应的pod），virtualService用来修饰满足什么条件后被哪个后端处理。而destinationRule描述的是这个请求到达某个后端后该怎么去处理。</p>
<p>简述：vs设置服务的访问规则，具体请求服务时的规则由dr来决定。</p>
<p>关键属性：</p>
<p>（1）host：必选字段，表示规则的使用对象，对应的也是k8s中的service。域名解析方式与之前的host配置一致。</p>
<p>（2）trafficPolicy：规则的内容定义，包括负载均衡，连接池策略，异常点检查等内容。</p>
<p>（3）exportTo：Istio 1.1版本后新增的特性，用于控制DestinationRule跨命名空间的可见性，这样就能控制在一个命名空间下定义的资源对象是否可以被其他命名空间下的Sidecar执行。如果不做赋值代表全命名空间都可见。支持“.” 代表当前命名空间可见。”*” 代表全命名空间可见。</p>
<p>（4）subsets：代表一个服务的子集，一般代表一个服务的版本，与vs结合使用。每个子集都是通过label来匹配对应的pod，在istio的使用要求中建议用户为每个pod分配app、version两个标签。所以subset一般以version来划分，但这并不是硬性限制。</p>
<h3 id="1-负载均衡设置"><a href="#1-负载均衡设置" class="headerlink" title="1.负载均衡设置"></a>1.负载均衡设置</h3><p>简述：当subset中可以匹配到多个pod时可以通过istio自身的负载均衡策略将请求分配。</p>
<ol>
<li>ROUND_ROBIN：轮循算法，如果设置了dr但没有为subset设置负载策略，那么会默认使用这个策略</li>
<li>LEAST_CONN：最少连接算法，算法实现的是从两个随机选择的后端服务中选择一个链接数最少的链接</li>
<li>RANDOM：完全随机策略，从现有的健康可用的后端服务中随机抽取一个地址</li>
<li>PASSTHROUGH：直接转发到客户端链接的目标地址，不做转发（这样会有k8s的service进行负载）</li>
</ol>
<h3 id="2-连接池设置"><a href="#2-连接池设置" class="headerlink" title="2.连接池设置"></a>2.连接池设置</h3><p>简述：通过连接池管理可以配置阈值来放置一个服务的失败影响到整个应用。istio的连接池可以配置tcp流量、http流量治理</p>
<p>tcp连接池配置（TCPSetting）：</p>
<p>（1）maxConnections：表示为上有服务的所有实例的最大连接数，默认为1024.对于HTTP只适用于HTTP/1.1因为HTTP/2对每个主机都使用单个连接。</p>
<p>（2）connectTimeout：TCP连接超时时间。</p>
<p>（3）tcpKeeplive：是Istio1.1版本后新增的特性，定期给对端发送一个keepalive的探测包，判断连接是否可用。包含三个属性–probes（标识有多少次探测没有反应就判断连接断开，默认使用操作系统的默认配置，linux默认为9），time（标识发送探测前连接空闲了多少时间，也是用操作系统的默认配置，linux默认为2小时），interval（探测间隔，也是用操作系统的默认配置，linux默认为75秒）。</p>
<p>http连接池配置（HTTPSetting）：</p>
<p>（1）http1MaxPendingRequests：最大等待HTTP请求数，默认值为1024，只适用于HTTP/1.1，因为HTTP/2协议的请求在到来时会立即复用连接，不会再连接池等待</p>
<p>（2）http2MaxRequests：最大请求数，默认1024。只适用于HTTP/2服务，因为HTTP/1.1适用最大连接数配置maxConnections即可。</p>
<p>（3）maxRequestsPerConnection：每个连接的最大请求数。如果不配置则不作限制</p>
<p>（4）maxRetries：最大重试次数，默认为3，表示服务可以执行的最大重试次数。如果调用后端因网络抖动导致调用失败，可能会带来业务损失，一般建议配置重试，若重试成功则可以正常配置返回数据，只不过比原来响应的时间稍慢一点。但重试次数过多会对性能产生影响，尽量不要对消耗大的服务进行重试。</p>
<p>（5）idleTimeout：空闲超时，定义在多长时间内没有活动请求则关闭连接。</p>
<h3 id="3-异常实例检测设置"><a href="#3-异常实例检测设置" class="headerlink" title="3.异常实例检测设置"></a>3.异常实例检测设置</h3><p>简述：异常点检查就是定期考察被访问的服务实例的工作情况，如果连续出现访问异常，则将服务实例标记为异常并进行隔离，在一段时间内不为其分配流量，过一段时间被移除的实例会被解除移除，尝试请求，如果访问失败会进行更长实际胺的隔离，这也是istio的熔断功能。<br>参数配置：</p>
<ol>
<li>consecutiveErrors：实例被驱逐前的连续错误次数，默认为5，对于http服务返回502,503,504的返回码会认为服务异常。</li>
<li>interval：驱逐检查的时间间隔（驱逐检测的统计时间），默认为10秒，要求大于1毫秒，单位可以是时、分、毫秒</li>
<li>baseEjectionTime：最小驱逐时间。一个服务被驱逐的时间等于驱逐次数乘以最小驱逐时间。所以被驱逐的实例再被再次驱逐时会变得越来越长。时间默认为30秒，要求大于1毫秒，单位可以是时、分、毫秒。</li>
<li>maxEjectionPercent：服务的可驱逐故障实例的最大比例，默认为10%。官方不建议配置过高，过分的驱逐会影响服务的服务能力</li>
<li>minHealthPercent：最小健康比例，是istio 1.1版本后新增的特性，当负载的实例中，如果健康的实例数量低于这个比例，istio会进入恐慌模式，异常检查功能会被禁用，所有的服务不论是否是故障实例都可以接受请求。</li>
</ol>
<p>例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">cicdapi</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">paas</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">host:</span> <span class="string">cicdapi</span></span><br><span class="line"> <span class="attr">trafficPolicy:</span></span><br><span class="line">   <span class="attr">connectionPool:</span></span><br><span class="line">     <span class="attr">tcp:</span></span><br><span class="line">       <span class="attr">maxConnections:</span> <span class="number">80</span></span><br><span class="line">       <span class="attr">connectTimeout:</span> <span class="string">25ms</span></span><br><span class="line">     <span class="attr">http:</span></span><br><span class="line">       <span class="attr">http2MaxRequest:</span> <span class="number">800</span></span><br><span class="line">       <span class="attr">maxRequestsPerConnection:</span> <span class="number">10</span></span><br><span class="line">   <span class="attr">outlierDetection:</span></span><br><span class="line">     <span class="attr">consecutiveErrors:</span> <span class="number">5</span></span><br><span class="line">     <span class="attr">interval:</span> <span class="string">4m</span></span><br><span class="line">     <span class="attr">baseEjectionTime:</span> <span class="string">10m</span></span><br><span class="line">     <span class="attr">maxEjectionPercent:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>
<p>检查4分钟内cicdapi服务的异常情况，连续出现5次连接异常的服务实例会被隔离10分钟，被隔离的服务数量不能超过30%。达到十分钟后实例会重新接受请求，如果依然不能正常工作会被隔离20分钟</p>
<h3 id="4-端口策略"><a href="#4-端口策略" class="headerlink" title="4.端口策略"></a>4.端口策略</h3><p>简述：当我们熟悉以上的连接池配置后，实际端口配置也没有什么特殊的地方，实际上就是为了某些端口配置一些特殊规则，比如最大连接数等</p>
<p>例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">cicdapi</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">paas</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">host:</span> <span class="string">cicdapi</span></span><br><span class="line"> <span class="attr">trafficPolicy:</span></span><br><span class="line">   <span class="attr">connectionPool:</span></span><br><span class="line">     <span class="attr">tcp:</span></span><br><span class="line">       <span class="attr">maxConnections:</span> <span class="number">80</span></span><br><span class="line">   <span class="attr">portLevelSettings:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">port:</span> </span><br><span class="line">       <span class="attr">number:</span> <span class="number">8081</span></span><br><span class="line">     <span class="attr">connectionPool:</span></span><br><span class="line">       <span class="attr">tcp:</span></span><br><span class="line">         <span class="attr">maxConnections:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>
<p>cicd服务的最大连接数为80，但8081端口单独配置了最大连接数为100</p>
<h3 id="5-服务子集"><a href="#5-服务子集" class="headerlink" title="5.服务子集"></a>5.服务子集</h3><p>简述：subset主要作用就是通过label标签配置真实的后端服务。virtualService中通过制定subset的name来引用对应的服务。</p>
<p>name：必选字段，subset的名字，通过virtualService引用subset的时候就是通过name来引用的</p>
<p>labels：服务标签，通过标签来引用真实的后端服务，最常用的标签为version标签</p>
<p>trafficPolicy：应用到这个subset的流量策略</p>
<p>例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DestinationRule</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cicdapi</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">paas</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">cicdapi</span></span><br><span class="line">  <span class="attr">subset:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v2</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">version:</span> <span class="string">v2</span></span><br><span class="line">  <span class="attr">trafficPolicy:</span></span><br><span class="line">    <span class="attr">connectionPool:</span></span><br><span class="line">      <span class="attr">tcp:</span></span><br><span class="line">        <span class="attr">maxConnections:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>dr的作用主要就是配置目标服务的匹配方式和负载均衡、熔断的服务治理方式。</p>
<h1 id="Gateway服务网关"><a href="#Gateway服务网关" class="headerlink" title="Gateway服务网关"></a>Gateway服务网关</h1><p>之前的配置不论是vs还是dr的配置都是针对服务间的访问做的样例，没有针对过外部请求访问容器服务的样例。这种请求都需要通过istio的服务网关来配置。</p>
<p>样例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Gateway</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cicdfront-gateway</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">istio:</span> <span class="string">ingressgateway</span> <span class="comment"># use istio default controller</span></span><br><span class="line">  <span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;cicdfront.com&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">VirtualService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cicd-front</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">frontend</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cicdfront.com</span></span><br><span class="line">  <span class="attr">gateways:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cicdfront-gateway</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">mesh</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">route:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">destination:</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">cicd-front</span></span><br><span class="line">        <span class="attr">port:</span></span><br><span class="line">          <span class="attr">number:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>
<h2 id="Gateway规则定义"><a href="#Gateway规则定义" class="headerlink" title="Gateway规则定义"></a>Gateway规则定义</h2><p>Gateway一般需要与virtualService结合使用，Gateway定义了服务从外面怎么访问，virtualService定义了匹配到内部服务怎么流转。<br>关键配置：</p>
<p>selector：必选字段，表示Gateway负载，为入口处的Envoy运行的pod标签</p>
<p>server：必选字段，表示开放的服务列表</p>
<h2 id="后端服务Server"><a href="#后端服务Server" class="headerlink" title="后端服务Server"></a>后端服务Server</h2><p>简述：server定义了服务的访问入口</p>
<ol>
<li>port：必选字段，描述了服务在哪个端口对外开放，是对外监听端口。</li>
<li>hosts：必选字段，为Gateway发布的服务地址，是一个域名，用来匹配virtualService的hosts，会匹配到设置了同样hosts的vs。</li>
</ol>
<p>例：</p>
<p>servers:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">servers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span></span><br><span class="line">      <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;cicdfront.com&quot;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="ServiceEntry"><a href="#ServiceEntry" class="headerlink" title="ServiceEntry"></a>ServiceEntry</h1><h2 id="ServiceEntry是用作外部服务配置。"><a href="#ServiceEntry是用作外部服务配置。" class="headerlink" title="ServiceEntry是用作外部服务配置。"></a>ServiceEntry是用作外部服务配置。</h2><p>简述：将网格外的服务加入网络中，像网格内的服务一样管理，实际上就是将不归属istio自动注入的服务加入到istio的服务发现。</p>
<p>配置示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.istio.io/v1alpha3</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceEntry</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cicdfront-entry</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">hosts：</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">www.cicddb.com</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">number:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">HTTP</span></span><br><span class="line">  <span class="attr">resolution:</span> <span class="string">DNS</span></span><br><span class="line">  <span class="attr">location:</span> <span class="string">MESH_EXTERNAL</span></span><br></pre></td></tr></table></figure>
<h2 id="ServiceEntry规则定义"><a href="#ServiceEntry规则定义" class="headerlink" title="ServiceEntry规则定义"></a>ServiceEntry规则定义</h2><p>重要参数：</p>
<ol>
<li><p>hosts：必选字段，表示ServiceEntry相关的主机名，可以是一个DNS域名，可以使用前缀模糊匹配</p>
</li>
<li><p>addresses：表示与服务关联的虚拟IP地址。</p>
</li>
<li><p>port：表示与外部服务关联的端口。</p>
</li>
<li><p>location：设置服务时在网格内还是网格外，支持以下两种模式</p>
<p>（1）MESH_EXTERNAL：表示在网格外部，通过api访问的外部服务。<br>（2）MESH_INTERNAL：表示在网格内部，一些不能直接注册到服务网格注册中心的服务。</p>
</li>
<li><p>resolution： 表示服务的发现模式，将服务名解析到一个后端的IP上。可以设置NONE、STATIC、DNS三种模式<br>（1）NONE：用于连接的目标地址已经是一个明确的IP场景是使用。<br>（2）STATIC：用在已经使用endpoint设置了服务示例的地址场景中， 也不需要解析。<br>（3）DNS：表示用查询环境中的DNS进行解析，前提是没有在hosts中使用通配符。</p>
</li>
<li><p>subjectAltNames： 表示这个服务负载的SAN列表</p>
</li>
<li><p>endpoints：表示与网格服务关联的网络地址，可以是一个IP，可以是一个主机名。endpoints通过很多字段一同生成<br>（1）address： 必选字段，表示网络后端的服务地址<br>（2）ports：端口列表<br>（3）labels：后端的标签<br>（4）locality：后端的locality，用于亲和性路由<br>（5）weight：表示负载均衡的权重。</p>
</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>我们在正常使用中，多使用的一般只有virtualService，destinationRule、Gateway这三种功能。vs负责配置访问规则、dr负责配置目标实例和负载规则，Gateway负责配置入口规则。配置好这三种配置就可以满足我们大部分的使用场景。</p>
<blockquote>
<p>但在使用中会发现这几种问题</p>
</blockquote>
<p>istio基本所有的功能配置时都要求一个必填字段hosts,在k8s集群中 ，这个hosts是我们服务的长短域名，也就是service的名称。所以在很大程度来讲，istio都是基于service在工作。但是istio没有图形界面提供功能配置，不论是vs,dr,gw都是需要通过yaml配置的。这种配置就不能限制用户的一些误操作，比如对一个服务配置误配置了两个vs，那么哪个会是有效的vs？对一个服务配置了两个dr，那么哪个会是有效的dr？前面提过istio在1.1版本之后新增了exportTo属性，代表当前配置能否支持跨namespace，默认都是允许跨namespace生效的，这样会不会出现误引用的情况？</p>
<blockquote>
<p>所以在使用时还是建议封装istio的yaml拼装功能，通过页面进行控制，防止误配置yaml。</p>
</blockquote>
<ol>
<li><p>istio会进行服务间的流量治理，实现方式是通过iptables进行流量拦截，这样使用时为了让入口服务也能被istio治理就必须使用istio的入口网关Gateway。这样平台使用时就不能直接为用户提供route的方式访问平台。需要使用gateway进行包装才行。但并不是所有服务都需要进行包装，只有需要在集群外直接访问的服务需要进行这个包装。（大部分都是前台服务才需要进行这个步骤：浏览器 —&gt; cicd-front —&gt; cicd-api，这种情况下就需要为cicdfront生成入口网关，用户需要通过入口网关访问cicdfront才能治理这部分流量）</p>
</li>
<li><p>集群内不能直接访问集群外的url</p>
</li>
</ol>
<hr>
<p>本文为CSDN博主「小魏的博客」的原创文章，本篇仅供学习使用，尊重原创</p>
<p>原文链接：<a target="_blank" rel="noopener" href="https://blog.csdn.net/w2009211777/article/details/123840631">https://blog.csdn.net/w2009211777/article/details/123840631</a></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC/">服务网格</a><a class="post-meta__tags" href="/tags/%E6%9C%AA%E6%9D%A5%E8%B6%8B%E5%8A%BF/">未来趋势</a></div><div class="post_share"><div class="social-share" data-image="https://s1.ax1x.com/2022/07/05/jYhAaD.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/article/b4bbe9af.html" title="MySQL锁的理解"><img class="cover" src="https://img2.baidu.com/it/u=3622408705,4229293391&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=PNG?w=677&amp;h=500" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/404.gif'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">MySQL锁的理解</div></div></a></div><div class="next-post pull-right"><a href="/article/efc815e8.html" title="MybatisPlus快速入门"><img class="cover" src="https://img0.baidu.com/it/u=2125072226,3396411827&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=889&amp;h=500" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/404.gif'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">MybatisPlus快速入门</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://z1.ax1x.com/2023/11/16/pitl5tA.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/404.gif'" alt="avatar"/></div><div class="author-info__name">北秋</div><div class="author-info__description">慢慢来，会很快</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">12</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">17</div></a></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://beiqiu.top/404.html" target="_blank" title="QQ"><i class="iconfont icon-QQ"></i></a><a class="social-icon" href="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@latest/overall-situation/img/wx.jpg" target="_blank" title="微信"><i class="iconfont icon-weixin"></i></a><a class="social-icon" href="https://space.bilibili.com/3546588555250207" target="_blank" title="哔哩哔哩"><i class="iconfont icon-bilibili"></i></a><a class="social-icon" href="https://github.com/Beiqiu666" target="_blank" title="Github"><i class="iconfont icon-githublogo"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">如果阅读过程中遇到了问题，请及时评论或者链接北秋wx，看到了会在第一时间给出回复。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E5%B8%A6%E6%9D%A5%E4%BA%86%E4%BB%80%E4%B9%88%E5%8F%98%E5%8C%96%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">服务网格带来了什么变化？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Istio%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.</span> <span class="toc-text">Istio介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Istio%E6%9E%B6%E6%9E%84"><span class="toc-number">4.</span> <span class="toc-text">Istio架构</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Istio%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.</span> <span class="toc-text">Istio模块介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Istio-%E7%9A%84%E6%A0%B8%E5%BF%83%E6%8E%A7%E4%BB%B6Envoy"><span class="toc-number">5.1.</span> <span class="toc-text">Istio 的核心控件Envoy</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pilot"><span class="toc-number">5.2.</span> <span class="toc-text">Pilot</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mixer"><span class="toc-number">5.3.</span> <span class="toc-text">Mixer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Citadel"><span class="toc-number">5.4.</span> <span class="toc-text">Citadel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Galley"><span class="toc-number">5.5.</span> <span class="toc-text">Galley</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Istio%E4%B9%8B%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86"><span class="toc-number">6.</span> <span class="toc-text">Istio之流量管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E8%AF%B7%E6%B1%82%E8%B7%AF%E7%94%B1"><span class="toc-number">6.1.</span> <span class="toc-text">1、请求路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%85%A5%E5%8F%A3%E7%BD%91%E5%85%B3%EF%BC%88Ingress%EF%BC%89%E5%92%8C%E5%87%BA%E5%8F%A3%E7%BD%91%E5%85%B3%EF%BC%88Egress%EF%BC%89"><span class="toc-number">6.2.</span> <span class="toc-text">2、入口网关（Ingress）和出口网关（Egress）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E5%92%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">6.3.</span> <span class="toc-text">3、服务发现和负载均衡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Istio%E4%B9%8B%E6%95%85%E9%9A%9C%E5%A4%84%E7%90%86"><span class="toc-number">7.</span> <span class="toc-text">Istio之故障处理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Istio%E4%B9%8B%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5"><span class="toc-number">8.</span> <span class="toc-text">Istio之故障注入</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E5%92%8C%E9%81%A5%E6%B5%8B"><span class="toc-number">9.</span> <span class="toc-text">策略和遥测</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%96%E7%95%A5"><span class="toc-number">9.1.</span> <span class="toc-text">策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%81%A5%E6%B5%8B%EF%BC%88Telemetry%EF%BC%89"><span class="toc-number">9.2.</span> <span class="toc-text">遥测（Telemetry）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-number">10.</span> <span class="toc-text">可视化</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#VirtualService%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE"><span class="toc-number">11.</span> <span class="toc-text">VirtualService路由规则配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#vs%E9%85%8D%E7%BD%AE%E4%B8%AD%E7%9A%84%E5%85%B3%E9%94%AE%E9%85%8D%E7%BD%AE%E9%A1%B9"><span class="toc-number">11.1.</span> <span class="toc-text">vs配置中的关键配置项:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HttpRoute"><span class="toc-number">11.2.</span> <span class="toc-text">HttpRoute</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTPRoute%E7%9A%84%E5%8C%B9%E9%85%8D%E8%A7%84%E5%88%99"><span class="toc-number">11.3.</span> <span class="toc-text">HTTPRoute的匹配规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HttpRoute%E7%9A%84%E8%B7%AF%E7%94%B1%E7%9B%AE%E6%A0%87"><span class="toc-number">11.4.</span> <span class="toc-text">HttpRoute的路由目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTPRedirect%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-number">11.5.</span> <span class="toc-text">HTTPRedirect重定向</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTPRewrite%E9%87%8D%E5%86%99"><span class="toc-number">11.6.</span> <span class="toc-text">HTTPRewrite重写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HTTPRerty%E9%87%8D%E8%AF%95"><span class="toc-number">11.7.</span> <span class="toc-text">HTTPRerty重试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mirror%E6%B5%81%E9%87%8F%E5%A4%8D%E5%88%B6"><span class="toc-number">11.8.</span> <span class="toc-text">Mirror流量复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HttpFaultInjection%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5"><span class="toc-number">11.9.</span> <span class="toc-text">HttpFaultInjection故障注入</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DestinationRule%E7%9B%AE%E6%A0%87%E8%A7%84%E5%88%99"><span class="toc-number">12.</span> <span class="toc-text">DestinationRule目标规则</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#DestinationRule%E8%A7%84%E5%88%99%E5%AE%9A%E4%B9%89"><span class="toc-number">12.1.</span> <span class="toc-text">DestinationRule规则定义</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E8%AE%BE%E7%BD%AE"><span class="toc-number">12.1.1.</span> <span class="toc-text">1.负载均衡设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%BF%9E%E6%8E%A5%E6%B1%A0%E8%AE%BE%E7%BD%AE"><span class="toc-number">12.1.2.</span> <span class="toc-text">2.连接池设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%BC%82%E5%B8%B8%E5%AE%9E%E4%BE%8B%E6%A3%80%E6%B5%8B%E8%AE%BE%E7%BD%AE"><span class="toc-number">12.1.3.</span> <span class="toc-text">3.异常实例检测设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E7%AB%AF%E5%8F%A3%E7%AD%96%E7%95%A5"><span class="toc-number">12.1.4.</span> <span class="toc-text">4.端口策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%9C%8D%E5%8A%A1%E5%AD%90%E9%9B%86"><span class="toc-number">12.1.5.</span> <span class="toc-text">5.服务子集</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Gateway%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3"><span class="toc-number">13.</span> <span class="toc-text">Gateway服务网关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Gateway%E8%A7%84%E5%88%99%E5%AE%9A%E4%B9%89"><span class="toc-number">13.1.</span> <span class="toc-text">Gateway规则定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF%E6%9C%8D%E5%8A%A1Server"><span class="toc-number">13.2.</span> <span class="toc-text">后端服务Server</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ServiceEntry"><span class="toc-number">14.</span> <span class="toc-text">ServiceEntry</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ServiceEntry%E6%98%AF%E7%94%A8%E4%BD%9C%E5%A4%96%E9%83%A8%E6%9C%8D%E5%8A%A1%E9%85%8D%E7%BD%AE%E3%80%82"><span class="toc-number">14.1.</span> <span class="toc-text">ServiceEntry是用作外部服务配置。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ServiceEntry%E8%A7%84%E5%88%99%E5%AE%9A%E4%B9%89"><span class="toc-number">14.2.</span> <span class="toc-text">ServiceEntry规则定义</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">15.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/article/rz272701.html" title="如何看待知识付费"><img src="https://z1.ax1x.com/2023/12/04/piyDSWF.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/404.gif'" alt="如何看待知识付费"/></a><div class="content"><a class="title" href="/article/rz272701.html" title="如何看待知识付费">如何看待知识付费</a><time datetime="2023-09-21T11:50:33.000Z" title="发表于 2023-09-21 19:50:33">2023-09-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/xy272701.html" title="北秋闲鱼干货资料📒"><img src="https://img.39zn.cn/data/upload/ueditor/20200703/5efebbe573b25.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/404.gif'" alt="北秋闲鱼干货资料📒"/></a><div class="content"><a class="title" href="/article/xy272701.html" title="北秋闲鱼干货资料📒">北秋闲鱼干货资料📒</a><time datetime="2023-07-27T03:50:33.000Z" title="发表于 2023-07-27 11:50:33">2023-07-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/c8f15973.html" title="北秋有话说"><img src="https://z1.ax1x.com/2023/12/01/pisNPwF.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/404.gif'" alt="北秋有话说"/></a><div class="content"><a class="title" href="/article/c8f15973.html" title="北秋有话说">北秋有话说</a><time datetime="2023-05-14T05:14:00.000Z" title="发表于 2023-05-14 13:14:00">2023-05-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/e8c9c076.html" title="React通过useEffect使用定时器"><img src="https://p7.itc.cn/images01/20211123/ca47074f55954f32a596141cc77aeb17.jpeg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/404.gif'" alt="React通过useEffect使用定时器"/></a><div class="content"><a class="title" href="/article/e8c9c076.html" title="React通过useEffect使用定时器">React通过useEffect使用定时器</a><time datetime="2022-08-09T05:14:00.000Z" title="发表于 2022-08-09 13:14:00">2022-08-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/article/9ea696d1.html" title="远程过程调用(RPC)详解"><img src="https://s1.ax1x.com/2022/07/10/jyJOQx.jpg" onerror="this.onerror=null;this.src='https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/img/404.gif'" alt="远程过程调用(RPC)详解"/></a><div class="content"><a class="title" href="/article/9ea696d1.html" title="远程过程调用(RPC)详解">远程过程调用(RPC)详解</a><time datetime="2022-07-09T05:14:00.000Z" title="发表于 2022-07-09 13:14:00">2022-07-09</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://s1.ax1x.com/2022/06/23/jCECPP.jpg')"><div id="footer-wrap"><div id="ft"><div class="ft-item-1"><div class="t-top"><div class="t-t-l"><p class="ft-t t-l-t">公益广告</p><div class="bg-ad"><div>国家反诈中心APP，您的诈骗克星！举报犯罪，风险警示，防护知识应有尽有，守护好您的财产安全！</div><div class="btn-xz-box"><a class="btn-xz" target="_blank" rel="noopener" href="https://www.hack-gov.com.cn/posts/21480.html">下载（国家反诈中心） APP</a></div></div></div><div class="t-t-r"><p class="ft-t t-l-t">修仙导航</p><ul class="ft-links"><li><a href="https://beiqiu.top/photos/">来点壁纸</a><a href="https://beiqiu.top/music/" target="_blank">北秋音乐</a></li><li><a href="https://beiqiu.top/sponsorWall/">来杯咖啡</a><a href="https://beiqiu.top/comments/">留点什么</a></li><li><a href="https://beiqiu.top/about/">关于博主</a><a href="https://beiqiu.top/archives/">文章归档</a></li></ul></div></div></div><div class="ft-item-2"><p class="ft-t">推荐友链</p><div class="ft-img-group"><div class="img-group-item"><a href="https://beiqiu.top"><img src="https://z1.ax1x.com/2023/11/16/pitl5tA.jpg" alt=""/></a></div><div class="img-group-item"><a target="_blank" rel="noopener" href="https://fe32.top"><img src="https://bu.dusays.com/2022/05/02/626f92e193879.jpg" alt=""/></a></div><div class="img-group-item"><a target="_blank" rel="noopener" href="https://blog.zhheo.com"><img src="https://npm.elemecdn.com/guli-heo/img/avatar2.png" alt=""/></a></div><div class="img-group-item"><a target="_blank" rel="noopener" href="https://blog.anheyu.com"><img src="https://npm.elemecdn.com/anzhiyu-blog-static@1.0.4/img/avatar.jpg" alt=""/></a></div></div></div></div><div class="copyright">&copy;2021 - 2023  <i id="heartbeat" class="fa fas fa-heartbeat"></i> 北秋</div><div class="footer_custom_text"><a target="_blank" href="https://github.com/"><img src="https://img.shields.io/badge/Source-Github-%23f37f40?logo=github" title="世界最大的开源仓库"></a>&nbsp;<a target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" alt="img" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a>&nbsp;<a target="_blank" href="https://space.bilibili.com/3546588555250207"><img src="https://img.shields.io/badge/Exchange-Bilibili-%23ec8bb0?logo=bilibili" title="直达北秋Up主页"></a>&nbsp;<a target="_blank" href="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@latest/overall-situation/img/wx.jpg"><img src="https://img.shields.io/badge/%E5%8C%97%E7%A7%8B-%E7%82%B9%E5%87%BB%E8%81%94%E7%B3%BB%E6%88%91%E5%97%B7-%2307c160?logo=wechat" title="链接北秋"></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><div class="js-pjax"><script>(()=>{
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo.beiqiu.top/',
      region: '',
      onCommentLoaded: function () {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo.beiqiu.top/',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(function (res) {
      countELement.innerText = res[0].count
    }).catch(function (err) {
      console.error(err);
    });
  }

  const runFn = () => {
    init()
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') {
      setTimeout(runFn,0)
      return
    } 
    getScript('https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js').then(runFn)
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = () => {
      loadTwikoo()
    }
  }
})()</script></div><div id="message-container"></div><div class="aplayer no-destroy" data-id="7497337557" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listFolded="false" data-order="random" data-lrctype="1" data-preload="none" data-autoplay="true" muted></div><script defer src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js"></script><script data-pjax defer src="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/js/chocolate.js"></script><canvas id="universe"></canvas><script data-pjax defer src="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/js/universe.js"></script><script defer data-pjax src="https://cdn.jsdelivr.net/gh/beiqiu666/bq-blog@0.0.3/overall-situation/js/rightMenu.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="fa-solid fa-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="fa-solid fa-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="fa-solid fa-arrow-rotate-right"></i></div><div class="rightMenu-item" id="menu-home"><i class="fa-solid fa-house"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" href="/archives/"><i class="fa-solid fa-archive"></i><span>文章归档</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="fa-solid fa-folder-open"></i><span>文章分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="fa-solid fa-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuNormal"><a class="rightMenu-item menu-link" id="menu-radompage" href="javascript:bq.toRandomPost()"><i class="fa-solid fa-shoe-prints"></i><span>随便逛逛</span></a><div class="rightMenu-item" id="menu-translate"><i class="fa-solid fa-earth-asia"></i><span>繁简切换</span></div><div class="rightMenu-item" id="menu-darkmode"><i class="fa-solid fa-moon"></i><span>切换模式</span></div><div class="rightMenu-item" id="menu-print"><i class="fa-solid fa-print fa-fw"></i><span>打印页面</span></div></div></div><div id="rightmenu-mask"></div><!-- hexo injector body_end start --><script async src="//at.alicdn.com/t/font_2032782_8d5kxvn09md.js"></script><!-- hexo injector body_end end --></body></html>